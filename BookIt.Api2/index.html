<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Product App</title>
</head>
<body>
  <div>
    <h2>Add ApplicationUser to waiting list</h2>
    <input type="text" id="userId"/>
    <input type="text" id="resourceId"/>

    <input type="button" id="addUserToLine" value="Add" />
    
    <p id="message"></p>
  </div>
  
    <div>
        <h2>Waiting list</h2>
        <ul id="waitlist" />
    </div>
    
    <div class="register">
        <h2>You can register here...</h2>
        Your login: <input type='text' id='txtUserName'/>
        Pwd: <input type='text' id='txtPwd' />
        
        <input type='button' id='btnRegister' value='Register'/>
        <input type="button" id='btnLogin' value='Login'/>
        <input type="button" id='btnLogout' value='Logout' />

        <span class='msg'></span>
    </div>

    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.3.min.js"></script>
  <script>
      var uri = 'api/Waitlist/GetWaitingList';

    function createCookie(name, value, days) {
        var expires;

        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toGMTString();
        } else {
            expires = "";
        }
        document.cookie = escape(name) + "=" + escape(value) + expires + "; path=/";
    }

    function readCookie(name) {
        var nameEQ = escape(name) + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return unescape(c.substring(nameEQ.length, c.length));
        }
        return null;
    }

    function eraseCookie(name) {
        createCookie(name, "", -1);
    }

    $(document).ready(function() {

        function getAuthHeaders() {
            var headers = {};
            if (readCookie("bearerToken") != null) {
                headers.Authorization = "Bearer " + readCookie("bearerToken");
            }
            return headers;
        }

        function refreshList () {
            $('#waitlist').html('');

            $.ajax(uri, {
                dataType: 'json',
                method: 'get',
                headers: getAuthHeaders(),
                success:function(data) {
                    $.each(data, function (key, item) {
                        if (item != null) {
                            $('<li>', {
                                text: formatItem(item)
                            }).appendTo($('#waitlist'));
                        }
                    });
                },
                error: function(data) {
                    if (data.status == '401') {
                        $('#waitlist').text('No access');
                    }
                }
            });
        }

        var addMeToLine = function() {
            $.ajax('api/waitlist/addtolist' + '?resourceId=' + $('#resourceId').val(), {
                dataType: 'json',
                method: 'post',
                headers: getAuthHeaders(),
                success: function (data) {
                    if (data != null) {
                        $('#message').text(formatItem(data));
                        refreshList();
                    }
                }
            });
        };

        refreshList();

        function formatItem (item) {
            return item.ApplicationUser.UserName + ' booked ' + item.HubResource.Name + ' at ' + item.BookedTime;
        }

        var register = function() {
            $.ajax({
                url: 'api/Account/Register',
                dataType: 'json',
                method: 'POST',
                data: {
                    UserName: $('.register #txtUserName').val(),
                    Password: $('.register #txtPwd').val(),
                    ConfirmPassword: $('.register #txtPwd').val()
                },
                success: function(data) {
                    if (data != null) {
                        console.log(data);
                        $('.register .msg').text(function(d) {
                            return d;
                        }(data));
                        refreshList();
                    }
                },
                error: function(answer) {
                    console.log(answer);
                    $('.register .msg').text(answer.responseText);
                }
            });
        };

        var login = function() {
            $.ajax({
                url: 'api/account/login',
                method: 'POST',
                data: {
                    UserName: $('.register #txtUserName').val(),
                    Password: $('.register #txtPwd').val(),
                    RememberMe: true
                },
                success: function(data) {
                    if (data != null) {
                        console.log(data);
                        $('.register .msg').text(function(d) {
                            return d.statusText;
                        }(data));

                        window.location = window.location;
                        //refreshList();
                    }
                },
                error: function (answer) {
                    console.log(answer);
                    $('.register .msg').text(answer.responseText);
                }
            });
        };

        var logout = function() {
            $.ajax({
                url: 'api/Account/Logout',
                method: 'POST',
                headers: getAuthHeaders(),
                success: function (data) {
                    if (data != null) {
                        console.log(data);
                        $('.register .msg').text(function (d) {
                            return d.statusText;
                        }(data));
                        
                        refreshList();
                    }
                },
                error: function (answer) {
                    console.log(answer);
                    $('.register .msg').text(answer.responseText);
                }
            });
        };

        $('.register #btnRegister').click(register);
        $('.register #btnLogin').click(login);
        $('.register #btnLogout').click(logout);

        $('#addUserToLine').click(addMeToLine);
    });
  </script>
</body>
</html>